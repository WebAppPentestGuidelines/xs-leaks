+++
title = "XS-Search"
description = ""
date = "2020-10-01"
category = [
    "Attack",
    "Attack Principle",
]
defenses = [
    "Fetch Metadata",
    "SameSite Cookies",
]
menu = "main"
weight = 1
+++

XS-Search（クロスサイトサーチ）は、XS-Leaksのファミリーの中で重要な攻撃原理である。
この種の攻撃は、クエリベースの検索システムを悪用し、攻撃者のオリジンからユーザ情報をリークする[^1] [^2]。

典型的な攻撃は、検索システムが結果を返すかどうかを検出するためにレスポンス時間を用いて、以下のように行われる。


1. リクエストが、結果がヒットした場合の時間(hit）と、結果がヒットしなかった場合の時間(miss)を計測する。
2. 検索エンドポイントへのリクエストに対して、[timing attack]({{< ref "./timing-attacks/network-timing.md" >}})を開始し、最初の文字 (`?q=r`) をブルートフォースで攻撃する。
3. 2.で計測した時間が1.で計測したhitである場合、もう一文字追加する (`?q=ra`); そうでなければ、新しい文字 (`?q=s`) を試す。
4. 最終的に、完全な秘密(`?q=secret`)を取得できる。


この攻撃は、正確さを期すために複数のタイミング測定が必要であり、インフレーション技術や統計分析によって改善することができる。
さらに、一文字ずつブルートフォースするのではなく、攻撃者は特定の単語や文章を検索し、結果の出現箇所のみを漏洩させることができる。

この攻撃の最も重要な部分はその原理であり、様々なXS-Leaksに適用することが可能だからである。

## レスポンス時間の増加方法

XS-Searchのインフレーション技術は、2つのレスポンス（hitまたはmiss）を区別しやすくすることで攻撃の精度を上げるために使用される。
以下の2つのメカニズムにより、攻撃者はより良い計測を行うことができる。

- 検索システムが結果を返す際に、特定のGETパラメータをレスポンスに反映させると、レスポンスのサイズが大きくなる。これによりレスポンスをネットワーク上に送信する時間が大幅に増加するため、リクエストをより区別しやすくする。
- レスポンスを返す前に、サーバーにもっと計算作業をさせる。この方法は、より表現力の高いクエリー言語を提供する検索システムに適用できる。（例：Gmailのexclude termsは結果内のすべての文字を処理する）

## 拡張原理

XS-Search に関するオリジナルの研究はタイミング攻撃に焦点を当てたものであったが、この攻撃の原理は他の XS-Leak にも拡張されている。
前述のように信頼性の低いタイミング測定に頼るのではなく、攻撃者は他のXS-Leakを利用して同じ情報を抽出することができる。

クエリベースの検索システムでは、ユーザーはクエリを送信し、そのクエリに関連するレスポンスを取得する。
この動作は、2つの異なる結果をもたらす可能性がある。

1. システムが結果を表示し、ページが特定の動作をする(第一状態)。
2. システムが結果を表示せず、ページがステップ1とは異なる方法で動作する(第2の状態)。

上記の両方の挙動をタイミングよりも信頼性の高いXS-Leakで区別できれば、攻撃者はより効率的なXS-Search攻撃を行うことができる。
例えば、検索結果によってページのフレーム数が変化する（ステップ1と2が区別できる）場合、この攻撃原理は[Frame Counting]({{< ref "frame-counting.md" >}}) XS-Leakで適用でき、タイミング測定によるものよりも正確かもしれない。

## 対策

| Attack Alternative | [SameSite Cookies (Lax)]({{< ref "/docs/defenses/opt-in/same-site-cookies.md" >}}) | [COOP]({{< ref "/docs/defenses/opt-in/coop.md" >}}) | [Framing Protections]({{< ref "/docs/defenses/opt-in/xfo.md" >}}) |                                          [Isolation Policies]({{< ref "/docs/defenses/isolation-policies" >}})                                          |
| :----------------: | :--------------------------------------------------------------------------------: | :-------------------------------------------------: | :---------------------------------------------------------------: | :-----------------------------------------------------------------------------------------------------------------------------------------------------: |
| XS-Search (timing) |                                         ✔️                                          |                          ❌                          |                                 ❌                                 | [RIP]({{< ref "/docs/defenses/isolation-policies/resource-isolation" >}}) 🔗 [NIP]({{< ref "/docs/defenses/isolation-policies/navigation-isolation" >}}) |

🔗 –異なるシナリオに対して有効な防御機構を組み合わせる必要がある。

## References

[^1]: Cross-Site Search Attacks, [link](https://446h.cybersec.fun/xssearch.pdf)
[^2]: Cross-Site Search (XS-Search) Attacks - Hemi Leibowitz, OWASP AppSec IL 2015, [link](https://owasp.org/www-pdf-archive/AppSecIL2015_Cross-Site-Search-Attacks_HemiLeibowitz.pdf)
